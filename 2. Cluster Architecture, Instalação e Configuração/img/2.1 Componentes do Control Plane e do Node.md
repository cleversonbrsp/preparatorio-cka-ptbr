### **2. Cluster Architecture, Installation & Configuration (25%)**

---

O Kubernetes √© composto por uma arquitetura modular que garante sua robustez e flexibilidade. Nesta se√ß√£o, exploraremos os componentes principais do cluster, instala√ß√£o com `kubeadm`, configura√ß√£o, atualiza√ß√µes, alta disponibilidade, gerenciamento de runtime e backups essenciais.

![cluster components](https://kubernetes.io/images/docs/kubernetes-cluster-architecture.svg "Figure 1. Kubernetes cluster components.")

---

#### **2.1 Componentes do Control Plane e do Node**

O Kubernetes divide sua arquitetura em dois conjuntos de componentes principais:

##### **Control Plane (Plano de Controle)**
O Control Plane gerencia o estado desejado do cluster, garantindo que as cargas de trabalho estejam funcionando conforme esperado.

- **kube-apiserver**:  
  - Interface principal para comunica√ß√£o com o cluster.
  - Exposto via [API RESTful](#explicacao-api-restful).
  <details>
<summary id="explicacao-api-restful">API RESTful</summary>

**O que √© uma API RESTful?**

**API (Interface de Programa√ß√£o de Aplica√ß√µes)** √© uma forma de permitir que diferentes sistemas se comuniquem entre si. Quando falamos de **RESTful API**, estamos nos referindo a um tipo espec√≠fico de API que segue os princ√≠pios da arquitetura **REST** (Representational State Transfer).

### Principais Caracter√≠sticas de uma API RESTful:

1. **Baseada em HTTP**:  
   A comunica√ß√£o √© feita usando os m√©todos padr√£o do protocolo HTTP, como **GET**, **POST**, **PUT**, **DELETE**.

2. **Sem estado (Stateless)**:  
   Cada requisi√ß√£o feita para a API deve conter todas as informa√ß√µes necess√°rias para ser processada. Ou seja, o servidor n√£o armazena o estado da intera√ß√£o entre o cliente e a API. Cada requisi√ß√£o √© independente.

3. **Recursos identificados por URLs**:  
   Cada objeto ou dado que a API manipula √© um **recurso**, e esses recursos s√£o acessados por meio de URLs (endere√ßos web). Por exemplo:
   - `/users`: Para acessar informa√ß√µes sobre usu√°rios.
   - `/users/123`: Para acessar informa√ß√µes do usu√°rio com ID 123.

4. **M√©todos HTTP**:
   - **GET**: Para **ler** dados.
   - **POST**: Para **criar** novos recursos.
   - **PUT**: Para **atualizar** um recurso existente.
   - **DELETE**: Para **remover** um recurso.

5. **Formato comum de resposta**:  
   A resposta das requisi√ß√µes geralmente √© enviada em formatos como **JSON** ou **XML**, sendo o JSON o mais comum. Por exemplo, uma requisi√ß√£o GET pode retornar algo assim:
   ```json
   {
     "id": 123,
     "nome": "Jo√£o",
     "email": "joao@example.com"
   }


  - Valida e processa solicita√ß√µes de objetos do Kubernetes.

- **etcd**:  
  - Banco de dados chave-valor distribu√≠do.  
  - Armazena o estado do cluster.  
  - Alta disponibilidade √© crucial para integridade dos dados.

- **kube-scheduler**:  
  - Respons√°vel por atribuir Pods aos Nodes dispon√≠veis.  
  - Considera fatores como afinidade de Node, capacidade e pol√≠ticas de toler√¢ncia.

- **kube-controller-manager**:  
  - Executa processos de controle, como:
    - **Node Controller:** Gerencia o status dos Nodes.
    - **Replication Controller:** Garante o n√∫mero desejado de r√©plicas.
    - **Endpoints Controller:** Liga Pods aos Services.

- **cloud-controller-manager** (opcional):  
  - Gerencia a integra√ß√£o com provedores de nuvem, como AWS ou GCP.

##### **Node Components (Componentes dos N√≥s)**

Os Nodes executam as cargas de trabalho e reportam seu estado ao Control Plane.

- **kubelet**:  
  - Componente principal no Node.  
  - Garante que os cont√™ineres estejam rodando conforme especificado nos manifestos.

- **kube-proxy**:  
  - Gerencia as regras de rede.  
  - Suporta conectividade de rede entre Pods e Services.

- **Container Runtime**:  
  - Executa cont√™ineres.  
  - Exemplos: **containerd**, **CRI-O**, ou Docker (legacy).

---

#### **2.2 Instala√ß√£o de Clusters com `kubeadm`**

`kubeadm` √© uma ferramenta oficial para configurar clusters Kubernetes de maneira r√°pida e confi√°vel.

##### **Pr√©-requisitos**
1. **Infraestrutura:**
   - 1 Control Plane Node (m√≠nimo).  
   - 1 ou mais Worker Nodes.
2. **Sistema Operacional:**
   - Recomenda-se **Linux** (Ubuntu/Debian ou CentOS/Red Hat).
3. **Softwares Necess√°rios:**
   - Docker, `kubeadm`, `kubectl`, e `kubelet`.
4. **Requisitos de Rede:**
   - Portas abertas para comunica√ß√£o (6443, 10250, etc.).
   - Suporte a CNI (Container Network Interface).

##### **Passos para Instala√ß√£o**

1. **Instale os pr√©-requisitos nos Nodes**:
   - Atualize os pacotes:
     ```bash
     sudo apt update && sudo apt upgrade -y
     ```
   - Instale o Docker:
     ```bash
     sudo apt install docker.io -y
     ```
   - Instale o Kubernetes:
     ```bash
     sudo apt install -y kubeadm kubelet kubectl
     ```

2. **Inicialize o cluster no Control Plane Node**:
   - Use `kubeadm init`:
     ```bash
     kubeadm init --pod-network-cidr=192.168.0.0/16
     ```
   - Configure o `kubectl` no Node:
     ```bash
     mkdir -p $HOME/.kube
     sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
     sudo chown $(id -u):$(id -g) $HOME/.kube/config
     ```

3. **Adicione os Worker Nodes**:
   - Execute o comando exibido ap√≥s o `kubeadm init` no Worker Node:
     ```bash
     kubeadm join <control-plane-ip>:6443 --token <token> --discovery-token-ca-cert-hash sha256:<hash>
     ```

4. **Implemente um Plugin de Rede (CNI)**:
   - Exemplo: **Calico**.
     ```bash
     kubectl apply -f https://docs.projectcalico.org/manifests/calico.yaml
     ```

---

#### **2.3 Configura√ß√£o do `kubeconfig` para M√∫ltiplos Clusters**

O arquivo `kubeconfig` gerencia a autentica√ß√£o para acessar m√∫ltiplos clusters.

- **Verifique o arquivo `~/.kube/config`:**
  - Cont√©m:
    - Contextos.
    - Usu√°rios.
    - Clusters.

- **Troque entre clusters com `kubectl`:**
  ```bash
  kubectl config use-context <cluster-name>
  ```

- **Adicione um novo cluster ao arquivo:**
  ```bash
  kubectl config set-cluster <cluster-name> --server=<api-server-url> --certificate-authority=<ca-file>
  kubectl config set-context <context-name> --cluster=<cluster-name> --user=<user-name>
  kubectl config use-context <context-name>
  ```

---

#### **2.4 Atualiza√ß√£o de Clusters**

Manter o Kubernetes atualizado √© fundamental para seguran√ßa e novas funcionalidades.

1. **Verifique a vers√£o atual:**
   ```bash
   kubectl version --short
   ```

2. **Atualize o Control Plane:**
   ```bash
   sudo apt update && sudo apt install -y kubeadm
   kubeadm upgrade plan
   kubeadm upgrade apply vX.Y.Z
   ```

3. **Atualize os Nodes:**
   - Atualize `kubelet` e reinicie:
     ```bash
     sudo apt install -y kubelet
     sudo systemctl restart kubelet
     ```

---

#### **2.5 Backup e Restaura√ß√£o do etcd**

O etcd √© crucial para o estado do cluster. Backups regulares evitam perda de dados.

- **Backup Manual do etcd:**
  ```bash
  etcdctl snapshot save <backup-path>
  ```

- **Restaura√ß√£o do Backup:**
  ```bash
  etcdctl snapshot restore <backup-path> --data-dir <restored-data-dir>
  ```

---

### **Conclus√£o**
A configura√ß√£o e gerenciamento de clusters s√£o os alicerces para operar com Kubernetes de maneira eficiente. A pr√≥xima se√ß√£o abordar√° o t√≥pico **Workloads & Scheduling**, explorando o gerenciamento de aplica√ß√µes no Kubernetes.

---

Que tal? üöÄ